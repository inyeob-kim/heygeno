---
alwaysApply: true
description: 레이어드 아키텍처 기반 리팩토링 가이드라인
---

# 리팩토링 가이드라인

## 1. 레이어드 아키텍처 원칙

### 레이어 구조 (상위 → 하위)

```
Presentation/UI
    ↓
Domain (Service / UseCase)
    ↓
Data (Repository)
    ↓
External (API/Storage/SDK)
```

### 핵심 원칙

- **단방향 의존**: UI → Domain → Data → External
- **역참조 금지**: 하위 레이어는 상위 레이어를 참조하지 않음
- **책임 분리**: 각 레이어는 명확한 단일 책임만 가짐

### 레이어별 책임

#### Presentation/UI
- 화면 렌더링 (온보딩/홈/마켓/혜택/더보기)
- 위젯 컴포넌트
- UI 상태 표현 (로딩/에러/빈 상태)
- 사용자 입력 수집 (탭, 스크롤, 필터 선택, CTA 클릭)
- **금지**: 비즈니스 규칙, 데이터 변환, 에러 분기 로직

#### Domain (Service / UseCase)
- 앱 핵심 비즈니스 규칙
- 사용자 플로우 (온보딩 완료 조건, 추천 기준, 트래킹 정책)
- "화면에서 필요한 단위"로 묶어주는 UseCase/Facade 성격
- 여러 데이터 소스를 조합하여 의미 있는 도메인 객체 생성

#### Data (Repository)
- 데이터 소스 추상화
- 캐시 정책
- 동시 요청 합치기
- 페이지네이션
- Domain에 "데이터 제공"만 하고, UI 관심사와 분리

#### External
- API 클라이언트/SDK/스토리지/푸시/트래킹 등 외부 의존
- Data 레이어 뒤에 숨김

## 2. 화면/라우터 리팩토링 방향

### 화면의 책임 제한 (3가지)

1. **사용자 입력 수집**: 탭, 스크롤, 필터 선택, CTA 클릭
2. **상태에 따른 UI 렌더링**: 로딩/성공/에러/빈 상태
3. **서비스 호출 트리거**: 화면 진입 시 로딩 요청

### 주요 화면별 역할 분리

#### 온보딩
- **UI**: 단계형 입력/진행률/검증 메시지 표시
- **Domain**: 온보딩 완료 조건, 프로필 저장/수정 정책, 중간 저장/재개 규칙

#### 홈
- **UI**: 추천 카드, 가격 알림 요약, 최근 본 상품 표시
- **Domain**: 홈 구성 데이터 조립 (여러 소스 합치기), 홈 리프레시 정책 (캐시/만료)

#### 마켓
- **UI**: 리스트/필터/정렬/검색
- **Domain**: 검색/필터 규칙, 페이지네이션 정책, 중복 제거 (동일 쿼리 합치기)

#### 혜택
- **UI**: 캠페인/이벤트 목록, 참여 버튼
- **Domain**: 참여 조건/쿨다운/중복 참여 방지 규칙, 서버 트리거 처리

#### 더보기
- **UI**: 설정/약관/계정/알림 토글
- **Domain**: 설정 저장 정책, 로컬/서버 동기화 규칙

## 3. 서비스 레이어 설계

### 서비스 종류 (기능 도메인별 분리)

#### Auth/OnboardingService
- 가입/프로필/온보딩 단계 진행 규칙
- 재진입/스킵/완료 처리

#### PetService
- 반려동물 프로필 CRUD
- 건강/알레르기 매핑 규칙

#### RecommendationService
- 추천 계산 호출/조합
- 추천 기준 적용
- 결과 정규화

#### ProductService
- 상품 조회/검색/필터
- 상품 상세 조립
- 성분/점수 표기용 변환

#### PriceAlertService (TrackingService)
- 최저가 추적
- 알림 등록/해지
- 가격 히스토리 조회

#### Campaign/BenefitService
- 이벤트/캠페인 노출 규칙
- 참여 처리
- 보상/로그 정책

#### SettingsService
- 언어/알림/계정 설정
- 로컬-서버 동기화

### 의존성 주입 방향

```
UI → Service Interface
Service → Repository Interface
Repository → External API/Storage
```

- UI는 "서비스 인터페이스"만 의존
- 서비스는 "리포지토리 인터페이스"에 의존
- 리포지토리는 "외부 API/스토리지"에 의존
- 테스트에서는 서비스/리포지토리를 "대체 구현(Mock/Fake)"로 주입 가능

## 4. 상태 관리 (Riverpod) 최적화

### 상태 관리 원칙

- **상태는 가볍게, 로직은 서비스로**
- UI 상태 (선택값/탭/스크롤/필터)는 Presentation에서 관리
- 도메인 상태 (추천 결과/상품 리스트/캠페인 상태)는 Domain+Repository 경계에서 "읽기 모델"로 제공

### 컨트롤러 (Notifier) 설계

- **오케스트레이션 최소화**: 컨트롤러가 도메인 규칙을 갖지 않도록 함
- **서비스 호출 + 결과 바인딩 중심**: 컨트롤러는 서비스를 호출하고 결과를 상태에 바인딩만 함

### 성능 최적화 전략

#### Provider 설계
- **family**: (펫ID/상품ID/쿼리/필터) 단위로 분리해 필요한 것만 갱신
- **autoDispose**: 화면 이탈 시 해제해 메모리/중복 구독 방지 (단, 캐싱 정책과 조합)

#### 중복 방지
- 동일 키 요청은 Repository에서 합치거나 캐시 히트
- 리빌드 최소화: 화면 전체가 아니라 "섹션 단위"로 구독 범위 축소

## 5. 중복 코드 제거 전략 (DRY)

### 반복되는 영역을 "공통 모듈"로 흡수

#### 네트워크 호출 공통화
- 요청/응답 공통 처리
- 타임아웃/리트라이/에러 매핑
- 로깅/트래킹

#### 에러 핸들링 중앙화
- 에러 → 사용자 메시지/리커버리 액션 (재시도/로그인 유도/네트워크 안내) 매핑을 한 곳에서

#### 데이터 매핑/포맷팅 중앙화
- 날짜/통화/퍼센트/점수표기/단위 변환을 공통 유틸로 통일

#### 리포지토리 공통 패턴 정리
- 페이징/캐시/요청 합치기/서버-로컬 병합 등 "틀"을 만들어 중복 감소

### 핵심 원칙

화면/프로바이더에 흩어진 "API 호출+변환+예외분기"를 Repository/Service로 흡수해 UI는 단순화

## 6. 가독성/성능 개선 포인트

### 가독성

- **화면은 "작은 위젯"으로 분할**: 섹션 (추천/가격알림/혜택배너) 단위
- **긴 메서드는 "하나의 의도"만 갖게 쪼개기**
- **주석 대신 "이름으로 설명되는 구조"**

### 성능

- **불필요 재로딩 방지**: 화면 진입마다 강제 fetch 대신 "만료 기반" 전략
- **큰 트리 재빌드 방지**: 상태 구독 범위를 최소화 (섹션 위젯 단위)
- **비동기 패턴 일관화**: 로딩/에러/성공 상태 표준화로 UI 분기 단순화
- **캐싱/메모이제이션**: 동일 계산/동일 쿼리는 재사용

## 7. 라우터 (GoRouter) 클린업 방향

### 라우터의 책임

- 경로 정의
- Guard/Redirect
- **금지**: 인증/온보딩 완료 여부 같은 조건 판단 로직

### 조건 판단 처리

- 인증/온보딩 완료 여부 같은 조건 판단은 **서비스에서 결과만 제공**
- 화면 이동 로직 (예: 특정 조건이면 API 호출 후 라우팅) **금지**
- "조건 판단 → 라우팅" 사이에서 라우터가 로직을 품지 않도록

## 8. 코드 작성 시 체크리스트

### 화면 (Screen/Widget) 작성 시
- [ ] 비즈니스 로직이 화면에 있는가? → Service로 이동
- [ ] 데이터 변환이 화면에 있는가? → Service/Repository로 이동
- [ ] 에러 처리가 화면에 있는가? → 공통 에러 핸들러로 이동
- [ ] API 호출이 화면에 있는가? → Repository로 이동

### 서비스 작성 시
- [ ] 단일 책임 원칙을 따르는가?
- [ ] Repository 인터페이스에만 의존하는가?
- [ ] UI 관심사가 섞여있지 않은가?

### 리포지토리 작성 시
- [ ] 데이터 소스 추상화가 되어있는가?
- [ ] 캐시 정책이 명확한가?
- [ ] 동시 요청 합치기가 구현되어 있는가?

### 상태 관리 작성 시
- [ ] 컨트롤러가 도메인 규칙을 갖고 있지 않은가?
- [ ] family/autoDispose가 적절히 사용되고 있는가?
- [ ] 구독 범위가 최소화되어 있는가?
